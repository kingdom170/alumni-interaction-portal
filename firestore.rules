rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    function getUserRole() {
      return getUserData().role;
    }
    
    function isAlumni() {
      return getUserRole() == 'alumni';
    }
    
    function isStudent() {
      return getUserRole() == 'student';
    }
    
    function isTeacher() {
      return getUserRole() == 'teacher';
    }
    
    function isAlumniOrTeacher() {
      return isAlumni() || isTeacher();
    }
    
    // ============================================
    // USERS COLLECTION
    // ============================================
    match /users/{userId} {
      // Anyone can read basic user info
      allow read: if isAuthenticated();
      
      // Users can only create/update their own profile
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      
      // No one can delete users (admin only via console)
      allow delete: if false;
    }
    
    // ============================================
    // ALUMNI COLLECTION
    // ============================================
    match /alumni/{userId} {
      // Anyone authenticated can read alumni profiles
      allow read: if isAuthenticated();
      
      // Only the alumni can create/update their own profile
      allow create, update: if isOwner(userId) && isAlumni();
      allow delete: if false;
    }
    
    // ============================================
    // STUDENTS COLLECTION
    // ============================================
    match /students/{userId} {
      // Anyone authenticated can read student profiles
      allow read: if isAuthenticated();
      
      // Only the student can create/update their own profile
      allow create, update: if isOwner(userId) && isStudent();
      allow delete: if false;
    }
    
    // ============================================
    // TEACHERS COLLECTION
    // ============================================
    match /teachers/{userId} {
      // Anyone authenticated can read teacher profiles
      allow read: if isAuthenticated();
      
      // Only the teacher can create/update their own profile
      allow create, update: if isOwner(userId) && isTeacher();
      allow delete: if false;
    }
    
    // ============================================
    // EVENTS COLLECTION
    // ============================================
    match /events/{eventId} {
      // Anyone authenticated can read events
      allow read: if isAuthenticated();
      
      // Only alumni and teachers can create events
      allow create: if isAlumniOrTeacher();
      
      // Only event creator can update/delete
      allow update, delete: if isAuthenticated() && 
        isOwner(resource.data.createdBy);
      
      // Event Registrations Subcollection
      match /registrations/{userId} {
        // Anyone can read registrations
        allow read: if isAuthenticated();
        
        // Only students can register (create their own registration)
        allow create: if isOwner(userId) && isStudent();
        
        // Only the registered user can delete their registration
        allow delete: if isOwner(userId);
        
        // No updates to registrations
        allow update: if false;
      }
    }
    
    // ============================================
    // CHATS COLLECTION
    // ============================================
    match /chats/{chatId} {
      // Only participants can read the chat
      allow read: if isAuthenticated() && 
        request.auth.uid in resource.data.participants;
      
      // Only participants can create chat (both must exist)
      allow create: if isAuthenticated() && 
        request.auth.uid in request.resource.data.participants;
      
      // Only participants can update (for last message, unread count)
      allow update: if isAuthenticated() && 
        request.auth.uid in resource.data.participants;
      
      // No one can delete chats
      allow delete: if false;
      
      // Messages Subcollection
      match /messages/{messageId} {
        // Only participants can read messages
        allow read: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // Only participants can send messages
        allow create: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants &&
          request.resource.data.senderId == request.auth.uid;
        
        // Can update messages to mark as seen
        allow update: if isAuthenticated() && 
          request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
        
        // No one can delete messages
        allow delete: if false;
      }
    }
    
    // ============================================
    // JOBS COLLECTION
    // ============================================
    match /jobs/{jobId} {
      // Anyone authenticated can read jobs
      allow read: if isAuthenticated();
      
      // Only alumni can post jobs
      allow create: if isAlumni();
      
      // Only job creator can update/delete
      allow update, delete: if isAuthenticated() && 
        isOwner(resource.data.postedBy);
    }
    
    // ============================================
    // RESUME REQUESTS COLLECTION
    // ============================================
    match /resumeRequests/{requestId} {
      // Only student and assigned alumni can read
      allow read: if isAuthenticated() && (
        isOwner(resource.data.studentId) || 
        isOwner(resource.data.alumniId)
      );
      
      // Only students can create resume requests
      allow create: if isStudent() && 
        request.resource.data.studentId == request.auth.uid;
      
      // Only the assigned alumni can update (add feedback)
      allow update: if isAuthenticated() && 
        isOwner(resource.data.alumniId) && isAlumni();
      
      // Only the student can delete their own request
      allow delete: if isAuthenticated() && 
        isOwner(resource.data.studentId);
    }
  }
}
